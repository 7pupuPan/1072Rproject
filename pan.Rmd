---
title: "EPA_AQI"
author: "Pan"
date: "2019/6/1"
output: html_document
---
```{r,include = FALSE }
if(!require("tidyverse")) install.packages("tidyverse")
library(readr)
library(tidyverse)
library(tidyr)
library(readxl)
library(xlsx)
```



```{r}
#縣市代碼
library(readxl)
Taiwan_code <- read_excel("C:/Users/user/Documents/GitHub/1072Rproject/taiwan_code.xlsx",
                          col_types = c("text", "text", "text", "text"))
head(Taiwan_code)

```

排放量清冊 
```{r}
#有point,line,plane

library(readxl)
TEDS_point <- read_excel("C:/Users/user/Documents/GitHub/1072Rproject/TEDS9.0.xlsx",
                         col_types = c("text", "text", "text", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric")) 

TEDS_p_clear<-TEDS_point%>%
  gather(year,result,-type,-county,-county_code)%>%
  spread(key =  type, value =  result)%>%
  mutate(year=as.numeric(year))%>%
  arrange(county_code,year)
view(TEDS_p_clear)
```

```{r}

#處理單月份電力度數


path<-"C:/Users/user/Documents/GitHub/1072Rproject/CountyElectric.xlsx"

excel_sheets(path)

sheets=c(excel_sheets(path))
sheets[1]



#CE as CountyElectric
CE1<-read_excel(path,sheet=sheets[1],col_names=c("distinct_code","distinct","type","number","contract","value"),skip=1)%>%
  mutate(time=sheets[1])%>%
  group_by(distinct_code,distinct,time)%>%
  summarise(kWh=max(value))%>%
  na.omit()
CE1
```

```{r}
#處理各月份電力統計
path<-"C:/Users/user/Documents/GitHub/1072Rproject/CountyElectric.xlsx"
excel_sheets(path)

sheets=c(excel_sheets(path))
df <- data.frame()

#12月會有每年的累計 必須手動刪除

for(i in c(1:49)){
  df<-rbind(df,read_excel(path,sheet=i,col_names=c("distinct_code","distinct","type","number","contract","value"),skip=1)%>%
              na.omit()%>%
              mutate(time=sheets[i]))
              
}
df


CE_month<-df%>%
  group_by(distinct_code,distinct,time)%>%
  summarise(kWh=max(value))%>%
  inner_join(Taiwan_code,by="distinct_code")%>%
  select(-distinct.y)%>%
  rename(distinct=distinct.x)%>%
  mutate(year=substr(time, 1, 3),
         month=substr(time,4,5))%>%
  mutate(year=as.numeric(year)+1911)
  
CE_month  

# 
#  write.xlsx(as.data.frame(CE_month), "distinct_electric_month.xlsx",sheetName = "monthly",
#             col.names = T, row.names = F, append = F)
```



```{r}
#處理各年份電力統計


#CE as CountyElectric
CountyElectric_year <- read_excel("C:/Users/user/Documents/GitHub/1072Rproject/CountyElectric_year.xlsx", 
    col_types = c("text", "text", "text", 
        "numeric", "numeric", "numeric", 
        "numeric"),
    col_names=c("distinct_code","distinct","type","104","105","106","107"),
    skip=1)%>%
  gather(year,kW,-type,-distinct,-distinct_code)%>%
  group_by(distinct_code,distinct,year)%>%
  summarise(kWh=max(kW))%>%
  inner_join(Taiwan_code,by="distinct_code")%>%
  select(-distinct.y)

head(CountyElectric_year)

# write.xlsx(as.data.frame(CountyElectric_year), "distinct_electric_year.xlsx",sheetName = "yearly",
#            col.names = T, row.names = F, append = F)

```





